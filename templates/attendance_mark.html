{% extends 'base.html' %}
{% block content %}
<div class="attendance-container text-center py-5">
  <h1>ðŸ“‹ Employee Attendance System</h1>
  <p>Position yourself in front of the camera and click "Mark Attendance"</p>
  <div class="video-container d-inline-block p-3 bg-light rounded shadow-sm">
    <video id="video" width="500" height="400" autoplay muted></video>
    <div>
      <button id="markBtn" class="btn btn-success btn-lg rounded-pill mt-3">ðŸ“· Mark My Attendance</button>
    </div>
    <div id="status" class="mt-3 fw-bold fs-5"></div>
  </div>
</div>

<script>
const video = document.getElementById('video'),
      status = document.getElementById('status'),
      markBtn = document.getElementById('markBtn');

navigator.mediaDevices.getUserMedia({video:true})
  .then(stream => {
    video.srcObject = stream;
    status.textContent = 'âœ… Camera ready';
  })
  .catch(() => status.textContent = 'âŒ Camera access denied');

markBtn.onclick = () => {
  let chunks = [];
  status.textContent = 'ðŸ”„ Processing...';
  markBtn.disabled = true;

  let rec = new MediaRecorder(video.srcObject);
  rec.ondataavailable = e => chunks.push(e.data);
  rec.onstop = async () => {
    let blob = new Blob(chunks, {type:'video/webm'});
    let fd = new FormData(); fd.append('video', blob);
    try {
      let res = await fetch(window.location.pathname, {method:'POST', body:fd});
      let d = await res.json();
      status.textContent = res.ok ? `âœ… ${d.message}` : `âŒ ${d.message}`;
    } catch {
      status.textContent = 'âŒ Network error';
    } 
    markBtn.disabled = false;
  };
  rec.start();
  setTimeout(() => rec.stop(), 3000);
};
</script>
{% endblock %}
