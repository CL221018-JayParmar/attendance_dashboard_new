{% extends 'base.html' %}
{% block content %}
<style>
/* Your existing CSS here (same as aapne diya tha) */
</style>

<div class="attendance-container">
    <div class="company-header">
        <h1>ðŸ“‹ Employee Attendance System</h1>
        <p>Position yourself in front of the camera and click "Mark Attendance"</p>
    </div>
    
    <div class="video-container">
        <video id="video" width="500" height="400" autoplay></video>
        <div>
            <button id="markBtn" class="capture-btn">
                ðŸ“· Mark My Attendance
            </button>
        </div>
        <div id="status">Ready to capture attendance</div>
    </div>
</div>

<script>
const video = document.getElementById('video');
const status = document.getElementById('status');
const markBtn = document.getElementById('markBtn');
let recorder, chunks = [];

// Initialize webcam
navigator.mediaDevices.getUserMedia({video: true, audio: false})
    .then(stream => {
        video.srcObject = stream;
        status.innerHTML = 'âœ… Camera ready - Click button to mark attendance';
    })
    .catch(err => {
        status.innerHTML = 'âŒ Camera access denied or not available';
        status.className = 'error';
    });

// Start recording on button click
markBtn.onclick = () => {
    chunks = [];
    status.innerHTML = 'ðŸ”„ Processing... Please look at the camera';
    status.className = 'processing';
    markBtn.disabled = true;
    
    recorder = new MediaRecorder(video.srcObject);
    
    recorder.ondataavailable = e => {
        if (e.data.size > 0) chunks.push(e.data);
    };
    
    recorder.onstop = async () => {
        const blob = new Blob(chunks, {type: 'video/webm'});
        const formData = new FormData();
        formData.append('video', blob);
        
        try {
            const response = await fetch(window.location.pathname, {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (response.ok) {
                status.innerHTML = `âœ… ${data.message}`;
                status.className = 'success';
                setTimeout(() => {
                    status.innerHTML = 'Ready for next attendance';
                    status.className = '';
                }, 4000);
            } else {
                status.innerHTML = `âŒ ${data.message}`;
                status.className = 'error';
                setTimeout(() => {
                    status.innerHTML = 'Ready to try again';
                    status.className = '';
                }, 3000);
            }
        } catch (error) {
            status.innerHTML = 'âŒ Network error - Please try again';
            status.className = 'error';
        }
        
        markBtn.disabled = false;
    };
    
    recorder.start();
    setTimeout(() => {
        if (recorder && recorder.state === 'recording') {
            recorder.stop();
        }
    }, 3000);  // Increased recording time to 3 seconds
};
</script>
{% endblock %}
